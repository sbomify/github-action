---
name: CI/CD Pipeline

on:
  push:
    branches:
      - master
    tags:
      - v*.*
  pull_request:
    branches:
      - master

env:
  IMAGE_NAME: sbomify-action

jobs:
  sanity-checks:
    name: Sanity Checks
    runs-on: ubuntu-latest
    steps:
      - name: Code Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv sync --locked --dev

      - name: Run ruff linter
        run: |
            uv run ruff check sbomify_action tests

      - name: Run ruff formatter
        run: |
            uv run ruff format --check sbomify_action tests

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Code Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install Trivy
        run: |
          # Source version extraction script (sets TRIVY_VERSION, BOMCTL_VERSION)
          source ./scripts/generate_additional_packages.sh || { echo 'Failed to extract versions from Dockerfile' >&2; exit 1; }
          echo "Installing Trivy version: $TRIVY_VERSION"
          curl -sL \
            -o trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz \
            "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz"
          curl -sL \
            -o trivy_checksum.txt \
            "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_checksums.txt"
          sha256sum --ignore-missing -c trivy_checksum.txt
          tar xvfz trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          chmod +x trivy
          sudo mv trivy /usr/local/bin
          rm -f trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz trivy_checksum.txt

      - name: Load cached venv
        id: cached-uv-dependencies
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/uv.lock') }}

      - name: Install dependencies
        if: steps.cached-uv-dependencies.outputs.cache-hit != 'true'
        run: uv sync --locked --dev

      - name: Run tests
        run: |
          uv run pytest
        env:
          TOKEN: placeholder
          COMPONENT_ID: placeholder
          UPLOAD: 'false'
          PYTHONPATH: ${{ github.workspace }}

  container-tests:
    name: Container Tests
    runs-on: ubuntu-latest
    steps:
      - name: Code Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build container
        run: |
          docker build . -t gha

      - name: Run enrichment test
        run: |
          docker run --rm \
            -v $(pwd):/github/workspace \
            -w /github/workspace \
            -e TOKEN=placeholder \
            -e COMPONENT_ID=placeholder \
            -e UPLOAD=false \
            -e SBOM_FILE="tests/test-data/syft.cdx.json" \
            -e ENRICH=true \
            gha

  license-db-integration-test:
    name: License DB Integration Test
    runs-on: ubuntu-latest
    steps:
      - name: Code Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: uv sync --locked --dev

      - name: Install Trivy
        run: |
          source ./scripts/generate_additional_packages.sh || { echo 'Failed to extract versions from Dockerfile' >&2; exit 1; }
          echo "Installing Trivy version: $TRIVY_VERSION"
          curl -sL \
            -o trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz \
            "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz"
          tar xvfz trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          chmod +x trivy
          sudo mv trivy /usr/local/bin
          rm -f trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz

      - name: Generate Alpine SBOM with Trivy
        run: |
          # Generate SBOM for Alpine 3.20 image
          trivy image --format cyclonedx --output alpine-raw.cdx.json alpine:3.20

      - name: Enrich Alpine SBOM with license database
        run: |
          # Run enrichment - this will use the license-db source
          uv run sbomify-action
        env:
          TOKEN: placeholder
          COMPONENT_ID: placeholder
          SBOM_FILE: alpine-raw.cdx.json
          OUTPUT_FILE: alpine-enriched.cdx.json
          ENRICH: "true"
          UPLOAD: "false"

      - name: Verify license database enrichment
        run: |
          echo "=== Verifying License Database Enrichment ==="
          
          # Check that enrichment occurred from license-db source
          if grep -q '"sbomify:enrichment:source"' alpine-enriched.cdx.json && \
             grep -q 'license-db' alpine-enriched.cdx.json; then
            echo "✅ Found license-db enrichment source in SBOM"
          else
            echo "❌ No license-db enrichment found"
            exit 1
          fi
          
          # Count components with licenses
          TOTAL_COMPONENTS=$(jq '.components | length' alpine-enriched.cdx.json)
          COMPONENTS_WITH_LICENSES=$(jq '[.components[] | select(.licenses != null and (.licenses | length) > 0)] | length' alpine-enriched.cdx.json)
          
          echo "Total components: $TOTAL_COMPONENTS"
          echo "Components with licenses: $COMPONENTS_WITH_LICENSES"
          
          # At least 50% of Alpine packages should have licenses from our DB
          MIN_EXPECTED=$((TOTAL_COMPONENTS / 2))
          if [ "$COMPONENTS_WITH_LICENSES" -ge "$MIN_EXPECTED" ]; then
            echo "✅ License enrichment rate is acceptable ($COMPONENTS_WITH_LICENSES >= $MIN_EXPECTED)"
          else
            echo "❌ License enrichment rate too low ($COMPONENTS_WITH_LICENSES < $MIN_EXPECTED)"
            exit 1
          fi
          
          # Verify at least some components have the license-db source property
          LICENSE_DB_COUNT=$(grep -o '"license-db"' alpine-enriched.cdx.json | wc -l)
          echo "Components enriched by license-db: $LICENSE_DB_COUNT"
          
          if [ "$LICENSE_DB_COUNT" -lt 10 ]; then
            echo "❌ Expected at least 10 components enriched by license-db"
            exit 1
          fi
          echo "✅ License-db enrichment verified"

      - name: Verify SPDX license expressions are valid
        run: |
          echo "=== Verifying SPDX License Expressions ==="
          
          # Extract all license expressions and check they look like valid SPDX
          jq -r '.components[].licenses[]?.expression // empty' alpine-enriched.cdx.json | head -20
          
          # Check for common valid SPDX identifiers
          VALID_SPDX_COUNT=$(jq -r '.components[].licenses[]?.expression // empty' alpine-enriched.cdx.json | \
            grep -E '^(MIT|Apache-2\.0|GPL-[0-9]|BSD-[0-9]|ISC|MPL|LGPL|Zlib|OpenSSL)' | wc -l)
          
          echo "Valid SPDX expressions found: $VALID_SPDX_COUNT"
          
          if [ "$VALID_SPDX_COUNT" -ge 5 ]; then
            echo "✅ Found valid SPDX license expressions"
          else
            echo "❌ Expected more valid SPDX expressions"
            exit 1
          fi

      - name: Verify CLE lifecycle events
        run: |
          echo "=== Verifying CLE Lifecycle Events ==="
          
          # Check for CLE properties (ECMA-428 standard)
          # See: https://sbomify.com/compliance/cle/
          CLE_EOS_COUNT=$(jq '[.components[].properties[]? | select(.name == "cle:eos")] | length' alpine-enriched.cdx.json)
          CLE_EOL_COUNT=$(jq '[.components[].properties[]? | select(.name == "cle:eol")] | length' alpine-enriched.cdx.json)
          
          echo "Components with cle:eos: $CLE_EOS_COUNT"
          echo "Components with cle:eol: $CLE_EOL_COUNT"
          
          # Alpine 3.20 should have CLE dates set
          if [ "$CLE_EOS_COUNT" -ge 10 ]; then
            echo "✅ CLE end-of-support dates are being set"
          else
            echo "❌ Expected CLE end-of-support dates on components"
            exit 1
          fi
          
          if [ "$CLE_EOL_COUNT" -ge 10 ]; then
            echo "✅ CLE end-of-life dates are being set"
          else
            echo "❌ Expected CLE end-of-life dates on components"
            exit 1
          fi
          
          # Show sample CLE data
          echo "Sample CLE properties:"
          jq '.components[0].properties[]? | select(.name | startswith("cle:"))' alpine-enriched.cdx.json || true

      - name: Upload enriched SBOM artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: alpine-enriched-sbom
          path: alpine-enriched.cdx.json
          retention-days: 7

  augmentation-integration-test:
    name: Augmentation Integration Test
    runs-on: ubuntu-latest
    steps:
      - name: Code Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: uv sync --locked --dev

      - name: Setup test config file
        run: |
          # Copy test augmentation data to sbomify.json (default config location)
          cp tests/test-data/augmentation-test-data.json sbomify.json
          echo "Created sbomify.json with test augmentation data:"
          cat sbomify.json

      - name: Run augmentation on test SBOM
        run: |
          # Run augmentation on a sample CycloneDX SBOM
          uv run sbomify-action
        env:
          TOKEN: placeholder
          COMPONENT_ID: placeholder
          SBOM_FILE: tests/test-data/syft.cdx.json
          OUTPUT_FILE: augmented-sbom.cdx.json
          AUGMENT: "true"
          UPLOAD: "false"

      - name: Verify supplier information
        run: |
          echo "=== Verifying Supplier Information ==="
          
          # Check supplier name
          SUPPLIER_NAME=$(jq -r '.metadata.supplier.name // empty' augmented-sbom.cdx.json)
          echo "Supplier name: $SUPPLIER_NAME"
          
          if [ "$SUPPLIER_NAME" = "Acme Corporation" ]; then
            echo "✅ Supplier name correctly set"
          else
            echo "❌ Expected supplier name 'Acme Corporation', got '$SUPPLIER_NAME'"
            exit 1
          fi
          
          # Check supplier URLs
          SUPPLIER_URLS=$(jq -r '.metadata.supplier.url[]?' augmented-sbom.cdx.json | wc -l)
          echo "Supplier URLs count: $SUPPLIER_URLS"
          
          if [ "$SUPPLIER_URLS" -ge 1 ]; then
            echo "✅ Supplier URLs present"
          else
            echo "❌ Expected at least 1 supplier URL"
            exit 1
          fi
          
          # Check supplier contacts
          SUPPLIER_CONTACTS=$(jq '.metadata.supplier.contact | length' augmented-sbom.cdx.json)
          echo "Supplier contacts: $SUPPLIER_CONTACTS"
          
          if [ "$SUPPLIER_CONTACTS" -ge 1 ]; then
            echo "✅ Supplier contacts present"
          else
            echo "❌ Expected at least 1 supplier contact"
            exit 1
          fi

      - name: Verify manufacturer information
        run: |
          echo "=== Verifying Manufacturer Information ==="
          
          # Check manufacturer - can be on metadata.manufacture (1.5) or metadata.component.manufacturer (1.6+)
          MANUFACTURER=$(jq -r '.metadata.manufacture.name // .metadata.component.manufacturer.name // empty' augmented-sbom.cdx.json)
          echo "Manufacturer: $MANUFACTURER"
          
          if [ -n "$MANUFACTURER" ]; then
            echo "✅ Manufacturer information present: $MANUFACTURER"
          else
            echo "⚠️ Manufacturer not found (may depend on CycloneDX version)"
          fi

      - name: Verify authors information
        run: |
          echo "=== Verifying Authors Information ==="
          
          # Check authors array
          AUTHORS_COUNT=$(jq '.metadata.authors | length' augmented-sbom.cdx.json)
          echo "Authors count: $AUTHORS_COUNT"
          
          if [ "$AUTHORS_COUNT" -ge 2 ]; then
            echo "✅ Authors correctly added ($AUTHORS_COUNT authors)"
          else
            echo "❌ Expected at least 2 authors, got $AUTHORS_COUNT"
            exit 1
          fi
          
          # Verify author names
          AUTHOR_NAMES=$(jq -r '.metadata.authors[].name' augmented-sbom.cdx.json)
          echo "Author names: $AUTHOR_NAMES"
          
          if echo "$AUTHOR_NAMES" | grep -q "Jane Developer"; then
            echo "✅ Found expected author 'Jane Developer'"
          else
            echo "❌ Expected author 'Jane Developer' not found"
            exit 1
          fi

      - name: Verify license information
        run: |
          echo "=== Verifying License Information ==="
          
          # Check that licenses were added to metadata
          LICENSES=$(jq '.metadata.licenses' augmented-sbom.cdx.json)
          echo "Licenses: $LICENSES"
          
          if [ "$LICENSES" != "null" ] && [ "$(echo "$LICENSES" | jq 'length')" -ge 1 ]; then
            echo "✅ Licenses present in metadata"
          else
            echo "❌ Expected licenses in metadata"
            exit 1
          fi
          
          # Check for Apache-2.0 in license expression
          if jq -e '.metadata.licenses[]? | select(.expression != null) | .expression | contains("Apache-2.0")' augmented-sbom.cdx.json > /dev/null 2>&1; then
            echo "✅ Found Apache-2.0 in license expression"
          else
            echo "⚠️ Apache-2.0 not found in expression (may be in different format)"
          fi

      - name: Verify lifecycle phase
        run: |
          echo "=== Verifying Lifecycle Phase ==="
          
          # Check lifecycle phase (CycloneDX 1.5+)
          LIFECYCLE=$(jq -r '.metadata.lifecycles[]?.phase // empty' augmented-sbom.cdx.json | head -1)
          echo "Lifecycle phase: $LIFECYCLE"
          
          if [ "$LIFECYCLE" = "build" ]; then
            echo "✅ Lifecycle phase correctly set to 'build'"
          elif [ -n "$LIFECYCLE" ]; then
            echo "✅ Lifecycle phase present: $LIFECYCLE"
          else
            echo "⚠️ Lifecycle phase not found (may require CycloneDX 1.5+)"
          fi

      - name: Verify VCS information
        run: |
          echo "=== Verifying VCS Information ==="
          
          # Check for VCS external reference on root component
          VCS_URL=$(jq -r '.metadata.component.externalReferences[]? | select(.type == "vcs") | .url' augmented-sbom.cdx.json | head -1)
          echo "VCS URL: $VCS_URL"
          
          if [ -n "$VCS_URL" ]; then
            echo "✅ VCS URL present in external references"
            
            if echo "$VCS_URL" | grep -q "github.com/acme/example-project"; then
              echo "✅ VCS URL matches expected repository"
            else
              echo "⚠️ VCS URL doesn't match expected (got: $VCS_URL)"
            fi
          else
            echo "⚠️ VCS external reference not found"
          fi

      - name: Verify sbomify tool metadata
        run: |
          echo "=== Verifying sbomify Tool Metadata ==="
          
          # Check that sbomify was added as a tool
          SBOMIFY_TOOL=$(jq -r '.metadata.tools.components[]? | select(.name == "sbomify GitHub Action") | .name' augmented-sbom.cdx.json)
          
          if [ -n "$SBOMIFY_TOOL" ]; then
            echo "✅ sbomify tool metadata present"
          else
            # Try legacy format for older CycloneDX versions
            SBOMIFY_TOOL_LEGACY=$(jq -r '.metadata.tools[]? | select(.name == "sbomify GitHub Action") | .name' augmented-sbom.cdx.json)
            if [ -n "$SBOMIFY_TOOL_LEGACY" ]; then
              echo "✅ sbomify tool metadata present (legacy format)"
            else
              echo "❌ sbomify tool not found in metadata"
              exit 1
            fi
          fi

      - name: Upload augmented SBOM artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: augmented-sbom
          path: augmented-sbom.cdx.json
          retention-days: 7

  push-images:
    name: Push Docker Images
    runs-on: ubuntu-latest
    needs: [sanity-checks, integration-tests, container-tests, license-db-integration-test, augmentation-integration-test]
    if: github.event_name == 'push'
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # For tags, use the tag name (strip 'v' prefix if present)
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            # For branches, use just the short SHA
            VERSION=$(echo "${{ github.sha }}" | cut -c1-7)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Build image
        run: |
          docker build . \
            --file Dockerfile \
            --tag $IMAGE_NAME \
            --label "runnumber=${GITHUB_RUN_ID}" \
            --build-arg VERSION=${{ steps.version.outputs.version }} \
            --build-arg COMMIT_SHA=${{ github.sha }} \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg VCS_REF=${{ github.ref_name }}

      - name: Log in to registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: sbomifyhub
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push image
        run: |
          set -x
          GITHUB_IMAGE_ID=ghcr.io/${{ github.repository_owner }}/$IMAGE_NAME
          GITHUB_IMAGE_ID=$(echo $GITHUB_IMAGE_ID | tr '[A-Z]' '[a-z]')
          DOCKER_HUB_IMAGE_ID=sbomifyhub/$IMAGE_NAME

          VERSION=$(echo "${{ github.ref }}" | sed -e 's,.*/\(.*\),\1,')

          [[ "${{ github.ref }}" == "refs/tags/"* ]] && VERSION=$(echo $VERSION | sed -e 's/^v//')

          [ "$VERSION" == "master" ] && VERSION=latest

          echo VERSION=$VERSION
          docker tag $IMAGE_NAME $GITHUB_IMAGE_ID:$VERSION
          docker tag $IMAGE_NAME $DOCKER_HUB_IMAGE_ID:$VERSION

          docker push $GITHUB_IMAGE_ID:$VERSION
          docker push $DOCKER_HUB_IMAGE_ID:$VERSION

          echo \`\`\` >> ${GITHUB_STEP_SUMMARY}
          echo "Use $GITHUB_IMAGE_ID:$VERSION within GitHub" >> ${GITHUB_STEP_SUMMARY}
          echo "Use $DOCKER_HUB_IMAGE_ID:$VERSION outside of GitHub" >> ${GITHUB_STEP_SUMMARY}
          echo \`\`\` >> ${GITHUB_STEP_SUMMARY}

  upload-sbom:
    name: Upload SBOM
    needs: push-images
    if: github.event_name == 'push'
    permissions:
      id-token: write
      contents: read
      attestations: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate additional packages from Dockerfile
        run: ./scripts/generate_additional_packages.sh > container_additional_packages.txt

      - name: Determine version
        id: version
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Upload SBOM to Staging (CycloneDX)
        if: github.ref == 'refs/heads/master'
        uses: sbomify/github-action@master
        env:
          TOKEN: ${{ secrets.SBOMIFY_STAGE_TOKEN }}
          API_BASE_URL: https://stage.sbomify.com
          COMPONENT_ID: 'XNsX40tonzvv'
          LOCK_FILE: 'uv.lock'
          COMPONENT_NAME: 'sbomify Action'
          COMPONENT_VERSION: ${{ steps.version.outputs.short_sha }}
          COMPONENT_PURL: 'pkg:docker/sbomifyhub/sbomify-action@${{ steps.version.outputs.short_sha }}'
          PRODUCT_RELEASE: '["Engh9j4XTTwD:${{ steps.version.outputs.short_sha }}"]'
          SBOM_FORMAT: cyclonedx
          AUGMENT: true
          ENRICH: true
          UPLOAD: true
          OUTPUT_FILE: github-action.cdx.json

      - name: Upload SBOM to Staging (SPDX)
        if: github.ref == 'refs/heads/master'
        uses: sbomify/github-action@master
        env:
          TOKEN: ${{ secrets.SBOMIFY_STAGE_TOKEN }}
          API_BASE_URL: https://stage.sbomify.com
          COMPONENT_ID: 'XNsX40tonzvv'
          LOCK_FILE: 'uv.lock'
          COMPONENT_NAME: 'sbomify Action'
          COMPONENT_VERSION: ${{ steps.version.outputs.short_sha }}
          COMPONENT_PURL: 'pkg:docker/sbomifyhub/sbomify-action@${{ steps.version.outputs.short_sha }}'
          SBOM_FORMAT: spdx
          AUGMENT: true
          ENRICH: true
          UPLOAD: true
          OUTPUT_FILE: github-action.spdx.json

      - name: Upload Container SBOM to Staging (CycloneDX)
        if: github.ref == 'refs/heads/master'
        uses: sbomify/github-action@master
        env:
          TOKEN: ${{ secrets.SBOMIFY_STAGE_TOKEN }}
          API_BASE_URL: https://stage.sbomify.com
          COMPONENT_ID: 'gco2pG10whmy'
          DOCKER_IMAGE: 'sbomifyhub/sbomify-action:latest'
          COMPONENT_NAME: 'sbomify Action Container'
          COMPONENT_VERSION: ${{ steps.version.outputs.short_sha }}
          COMPONENT_PURL: 'pkg:docker/sbomifyhub/sbomify-action@${{ steps.version.outputs.short_sha }}'
          PRODUCT_RELEASE: '["Engh9j4XTTwD:${{ steps.version.outputs.short_sha }}"]'
          ADDITIONAL_PACKAGES_FILE: container_additional_packages.txt
          SBOM_FORMAT: cyclonedx
          AUGMENT: true
          ENRICH: true
          UPLOAD: true
          OUTPUT_FILE: github-action-container.cdx.json

      - name: Upload Container SBOM to Staging (SPDX)
        if: github.ref == 'refs/heads/master'
        uses: sbomify/github-action@master
        env:
          TOKEN: ${{ secrets.SBOMIFY_STAGE_TOKEN }}
          API_BASE_URL: https://stage.sbomify.com
          COMPONENT_ID: 'gco2pG10whmy'
          DOCKER_IMAGE: 'sbomifyhub/sbomify-action:latest'
          COMPONENT_NAME: 'sbomify Action Container'
          COMPONENT_VERSION: ${{ steps.version.outputs.short_sha }}
          COMPONENT_PURL: 'pkg:docker/sbomifyhub/sbomify-action@${{ steps.version.outputs.short_sha }}'
          ADDITIONAL_PACKAGES_FILE: container_additional_packages.txt
          SBOM_FORMAT: spdx
          AUGMENT: true
          ENRICH: true
          UPLOAD: true
          OUTPUT_FILE: github-action-container.spdx.json

      - name: Upload JavaScript Dependencies SBOM to Staging (CycloneDX)
        if: github.ref == 'refs/heads/master'
        uses: sbomify/github-action@master
        env:
          TOKEN: ${{ secrets.SBOMIFY_STAGE_TOKEN }}
          API_BASE_URL: https://stage.sbomify.com
          COMPONENT_ID: 'PGyKXNbQd5eq'
          LOCK_FILE: 'bun.lock'
          COMPONENT_NAME: 'JavaScript Dependencies'
          COMPONENT_VERSION: ${{ steps.version.outputs.short_sha }}
          PRODUCT_RELEASE: '["Engh9j4XTTwD:${{ steps.version.outputs.short_sha }}"]'
          SBOM_FORMAT: cyclonedx
          AUGMENT: true
          ENRICH: true
          UPLOAD: true
          OUTPUT_FILE: github-action-frontend.cdx.json

      - name: Upload JavaScript Dependencies SBOM to Staging (SPDX)
        if: github.ref == 'refs/heads/master'
        uses: sbomify/github-action@master
        env:
          TOKEN: ${{ secrets.SBOMIFY_STAGE_TOKEN }}
          API_BASE_URL: https://stage.sbomify.com
          COMPONENT_ID: 'PGyKXNbQd5eq'
          LOCK_FILE: 'bun.lock'
          COMPONENT_NAME: 'JavaScript Dependencies'
          COMPONENT_VERSION: ${{ steps.version.outputs.short_sha }}
          SBOM_FORMAT: spdx
          AUGMENT: true
          ENRICH: true
          UPLOAD: true
          OUTPUT_FILE: github-action-frontend.spdx.json

      - name: Upload SBOM to Production (CycloneDX)
        if: startsWith(github.ref, 'refs/tags/')
        uses: sbomify/github-action@master
        env:
          TOKEN: ${{ secrets.SBOMIFY_TOKEN }}
          COMPONENT_ID: 'Gu9wem8mkX'
          LOCK_FILE: 'uv.lock'
          COMPONENT_NAME: 'sbomify Action'
          COMPONENT_VERSION: ${{ github.ref_name }}
          COMPONENT_PURL: 'pkg:docker/sbomifyhub/sbomify-action@${{ github.ref_name }}'
          PRODUCT_RELEASE: '["IeIn1dGJXULh:${{ github.ref_name }}"]'
          SBOM_FORMAT: cyclonedx
          AUGMENT: true
          ENRICH: true
          UPLOAD: true
          OUTPUT_FILE: github-action.cdx.json

      - name: Upload SBOM to Production (SPDX)
        if: startsWith(github.ref, 'refs/tags/')
        uses: sbomify/github-action@master
        env:
          TOKEN: ${{ secrets.SBOMIFY_TOKEN }}
          COMPONENT_ID: 'Gu9wem8mkX'
          LOCK_FILE: 'uv.lock'
          COMPONENT_NAME: 'sbomify Action'
          COMPONENT_VERSION: ${{ github.ref_name }}
          COMPONENT_PURL: 'pkg:docker/sbomifyhub/sbomify-action@${{ github.ref_name }}'
          SBOM_FORMAT: spdx
          AUGMENT: true
          ENRICH: true
          UPLOAD: true
          OUTPUT_FILE: github-action.spdx.json

      - name: Upload Container SBOM to Production (CycloneDX)
        if: startsWith(github.ref, 'refs/tags/')
        uses: sbomify/github-action@master
        env:
          TOKEN: ${{ secrets.SBOMIFY_TOKEN }}
          COMPONENT_ID: 'ryD0Hcu4vq6y'
          DOCKER_IMAGE: 'sbomifyhub/sbomify-action:${{ github.ref_name }}'
          COMPONENT_NAME: 'sbomify Action Container'
          COMPONENT_VERSION: ${{ github.ref_name }}
          COMPONENT_PURL: 'pkg:docker/sbomifyhub/sbomify-action@${{ github.ref_name }}'
          PRODUCT_RELEASE: '["IeIn1dGJXULh:${{ github.ref_name }}"]'
          ADDITIONAL_PACKAGES_FILE: container_additional_packages.txt
          SBOM_FORMAT: cyclonedx
          AUGMENT: true
          ENRICH: true
          UPLOAD: true
          OUTPUT_FILE: github-action-container.cdx.json

      - name: Upload Container SBOM to Production (SPDX)
        if: startsWith(github.ref, 'refs/tags/')
        uses: sbomify/github-action@master
        env:
          TOKEN: ${{ secrets.SBOMIFY_TOKEN }}
          COMPONENT_ID: 'ryD0Hcu4vq6y'
          DOCKER_IMAGE: 'sbomifyhub/sbomify-action:${{ github.ref_name }}'
          COMPONENT_NAME: 'sbomify Action Container'
          COMPONENT_VERSION: ${{ github.ref_name }}
          COMPONENT_PURL: 'pkg:docker/sbomifyhub/sbomify-action@${{ github.ref_name }}'
          ADDITIONAL_PACKAGES_FILE: container_additional_packages.txt
          SBOM_FORMAT: spdx
          AUGMENT: true
          ENRICH: true
          UPLOAD: true
          OUTPUT_FILE: github-action-container.spdx.json

      - name: Upload JavaScript Dependencies SBOM to Production (CycloneDX)
        if: startsWith(github.ref, 'refs/tags/')
        uses: sbomify/github-action@master
        env:
          TOKEN: ${{ secrets.SBOMIFY_TOKEN }}
          COMPONENT_ID: 'IxwrYSb9rGql'
          LOCK_FILE: 'bun.lock'
          COMPONENT_NAME: 'JavaScript Dependencies'
          COMPONENT_VERSION: ${{ github.ref_name }}
          PRODUCT_RELEASE: '["IeIn1dGJXULh:${{ github.ref_name }}"]'
          SBOM_FORMAT: cyclonedx
          AUGMENT: true
          ENRICH: true
          UPLOAD: true
          OUTPUT_FILE: github-action-frontend.cdx.json

      - name: Upload JavaScript Dependencies SBOM to Production (SPDX)
        if: startsWith(github.ref, 'refs/tags/')
        uses: sbomify/github-action@master
        env:
          TOKEN: ${{ secrets.SBOMIFY_TOKEN }}
          COMPONENT_ID: 'IxwrYSb9rGql'
          LOCK_FILE: 'bun.lock'
          COMPONENT_NAME: 'JavaScript Dependencies'
          COMPONENT_VERSION: ${{ github.ref_name }}
          SBOM_FORMAT: spdx
          AUGMENT: true
          ENRICH: true
          UPLOAD: true
          OUTPUT_FILE: github-action-frontend.spdx.json

      - name: Attest Source SBOM (CycloneDX)
        if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: '${{ github.workspace }}/github-action.cdx.json'

      - name: Attest Source SBOM (SPDX)
        if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: '${{ github.workspace }}/github-action.spdx.json'

      - name: Attest Container SBOM (CycloneDX)
        if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: '${{ github.workspace }}/github-action-container.cdx.json'

      - name: Attest Container SBOM (SPDX)
        if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: '${{ github.workspace }}/github-action-container.spdx.json'

      - name: Attest JavaScript Dependencies SBOM (CycloneDX)
        if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: '${{ github.workspace }}/github-action-frontend.cdx.json'

      - name: Attest JavaScript Dependencies SBOM (SPDX)
        if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: '${{ github.workspace }}/github-action-frontend.spdx.json'
